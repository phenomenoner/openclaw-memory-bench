name: ci

on:
  push:
    branches: [main]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Set up Python
        run: uv python install 3.13

      - name: Sync deps
        run: uv sync

      - name: Lint
        run: uv run ruff check

      - name: Unit tests
        run: uv run pytest -q

      - name: Phase A/B smoke sanity (optional)
        if: ${{ vars.PHASE_AB_SMOKE == '1' }}
        run: scripts/smoke_phase_ab_compare.sh

      - name: Retrieval smoke run (openclaw-mem adapter when available)
        run: |
          if command -v openclaw-mem >/dev/null 2>&1; then
            uv run openclaw-memory-bench run-retrieval \
              --provider openclaw-mem \
              --dataset examples/mini_retrieval.json \
              --top-k 5
          else
            echo "openclaw-mem not found in CI environment, skipping adapter smoke run"
            uv run openclaw-memory-bench doctor
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: retrieval-artifacts
          path: artifacts/
          if-no-files-found: ignore
